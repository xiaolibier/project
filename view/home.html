<!doctype html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta content="IE=Edge,chrome=1" http-equiv="X-UA-Compatible">
	<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
	<meta content="yes" name="apple-mobile-web-app-capable">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="format-detection" content="telephone=no"/>
	<link rel="stylesheet" href="../public/css/common.css" />
	<title>经纬传奇系统</title>
	
</head>
<body class="">
	<div info="公共头部" class="header">
		<div class="logo_div">
			<a id="slideLmenu" class="slideLmenu"><img class="go_img" src="../public/img/s_io.png"></a>
		</div>
		<div id="menu_show_t" class="header_title">
			<span class="ss s0 active"></span><span class="ss s1"></span><span class="ss s2"></span>
			<div class="login_div">
				<a class="usr_head"></a>
				<a class="usr_name"></a>
				<!-- <a class="login_abtn">登录</a> -->
				<!-- <a href="javascript:;" class="out_abtn">退出</a> -->
				<!-- <a href="javascript:;" style="margin-left:10px;" class="changePassWord">修改密码</a> -->
				<a class="header_menu_ico" href="javascript:;"><img class="hmi_img" src="../public/img/hmi.png"/></a>
				<a href="javascript:;" id="bindWeixin" style="color:#ee8815;display:none;margin-left:20px;" class="">绑定微信</a>
				<a href="javascript:;" id="unbindWeixin" style="display:none;margin-left:20px;" class="">解绑微信</a>
				<ul class="hmi_ul">
					<li class="uli changePassWord">修改密码</li>
					<li class="uli out_abtn">退出</li>
					<!-- <li style="display:none;" id="bindWeixin" class="uli">绑定微信</li> -->
					<!-- <li style="display:none;" id="unbindWeixin" class="uli">解绑微信</li> -->
				</ul>
			</div>
		</div>
	</div>
	<div info="左侧菜单" id="common_menu" class="left_menu">
		<div id="scrollbarList" class="scrollbar">
		<div id="0" url="工作台.html" class="mm c1"><span class="text_c">工作台</span></div>
		<div id="1" class="mm c1"><span class="text_c">项目管理</span></div>
		<div id="11" pid="1" url="项目管理.html" class="mm c2"><span class="text_c">项目管理</span></div>
		<div id="2" class="mm c1"><span class="text_c">任务管理</span></div>
		<div id="21" pid="2" url="任务管理.html" class="mm c2"><span class="text_c">任务管理</span></div>
		<div id="22" pid="2" url="任务进度管理.html" class="mm c2"><span class="text_c">任务进度管理</span></div>
		<div id="23" pid="2" url="操作记录.html" class="mm c2"><span class="text_c">操作记录</span></div>
		<div id="3" class="mm c1"><span class="text_c">信息库</span></div>
		<div id="31" pid="3" url="园区管理.html" class="mm c2"><span class="text_c">园区管理</span></div>
		<div id="32" pid="3" url="客户管理.html" class="mm c2"><span class="text_c">客户管理</span></div>
		<div id="33" pid="3" url="用户管理.html" class="mm c2"><span class="text_c">用户管理</span></div>
		<div id="34" pid="3" url="权限管理.html" class="mm c2"><span class="text_c">权限管理</span></div>
		</div>
	</div>
	<div class="frame_div">
		<div style="position:relative;height:100%;">
		<iframe class="iframe" id="iframeObj"  src="工作台.html" height="98%" width="100%" frameborder="0"></iframe>
		</div>
	</div>
	
		<!-- 弹窗 -->
	<div info="弹窗背景" class="stip_bg"></div>
	<div info="弹窗容器" class="stip_box">
		<div class="stip_content">
			<!--  -->
			<div class="sbox xiugaimimaBox">
				<h4 class="sbox_h4">修改密码</h4>
				<div class="sbox_c"><span class="slable">旧密码</span><i class="star"></i><input id="password1" class="sbox_input" type="text"/></div>
				<div class="sbox_c"><span class="slable">新密码</span><i class="star"></i><input id="password2" class="sbox_input" type="text"/></div>
				<div class="sbox_c"><span class="slable">确认新密码</span><i class="star"></i><input id="password3" class="sbox_input" type="text"/></div>
				<div class="sbox_btn_div" style="text-align:center;">
					<a href="javascript:;" id="noBtn" onclick="closeSbox()" class="sbox_btn btn1">取消</a>
					<a id="yesBtn" style="margin-left:25px;" href="javascript:;" class="sbox_btn btn2">确认</a>
				</div>
			</div>
		</div>
	</div>	

<!-- 弹出层 -->
<div class="stip_bg stip_bg2"></div>
<div class="weixinloginerweima" style="display:none;top:50%;margin-top:-195px;left:50%;margin-left:-192px;position:fixed;z-index:999;" id="login_container"></div>
	
	
	<script type="text/javascript" src="../public/libs/jquery.min.js"></script>
	<script type="text/javascript" src="../public/libs/json.js"></script>
	<script type="text/javascript" src="../public/libs/base.js"></script>
	<script type="text/javascript" src="../public/libs/layer.js"></script>
	<script type="text/javascript" src="../public/libs/utils.js"></script>
	<!-- <script src="http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js"></script> -->
	<script type="text/javascript" src="../public/js/common1.js"></script>
	<!-- <script type="text/javascript" src="../public/js/index.js"></script> -->
	
	
	
<script>
$(function(){
	var g = {};
	g.login_token = Utils.offLineStore.get("token",false) || "";
	g.page = Utils.getQueryString("page") || "";
	g.httpTip = new Utils.httpTip({});
	g.totalPage = 1;//存总页数
	g.nowPage = 0;//存当前页 0 是第一页
	g.showPages = 10;//每页显示多少行
	g.loadPage1 = true;//判断页面刚加载一次 定义分页的地方用
	g.serTT = '';//存储所有按钮权限集合
	
/* **************************************** lodding ******************************************** */		
	//页面防止闪
	
	
	$('.out_abtn').on('click',loginOutFunc);
	$('.changePassWord').on('click',gochange);
	$('#bindWeixin').on('click',bindWeixinFunc);
	$('#unbindWeixin').on('click',unbindWeixinFunc);
	//getAllMenu();//获取所有菜单
	//loadWork();//加载工作台
	//getUserInfoFunc();//获取用户信息
	
	
/* **************************************** setTing ******************************************** */	
	
	
	menuFunction();//菜单定义事件
	//刚开始加载工作台
	function loadWork(){
		if(g.loadPage1 = true && g.page == ''){
			$('#iframeObj').attr('src','工作台.html');
			$('#menu_show_t .ss').removeClass('active').html('');
			$('#menu_show_t .s0').css('cursor','pointer').html('工作台');
			g.loadPage1 = false;
		}
	}
	//修改密码
	function gochange(){
		location.href = "changepass.html";
	}
	//显示退出 和 修改密码
	$('.usr_name,.header_menu_ico').click(function(){
		$('.hmi_ul').slideToggle(200);
	});
	
	//获取用户信息
	function getUserInfoFunc(){
		var condi = {};
		var url = Base.serverUrl + "user/currentUserInfo";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"GET",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					var data = data.result || {};
					var name1 = data.name || '';
					var uid = data.id || '';//用户id
					var icons = data.icons || '';
					var wechatHeadImgUrl = data.wechatHeadImgUrl || '';
					var hasLogin = data.hasLogin || '';//判断用户是否修改过密码
					var _style = 'background:url('+wechatHeadImgUrl+') no-repeat center center;background-size:contain;';
					$('.usr_name').html(name1);
					Utils.offLineStore.set("usernamestr",name1,false);//权限存储
					$('.usr_head').attr('style',_style);
					if(hasLogin == 0){//判断用户没有修改密码 提示修改
						if(confirm('系统检测到您还未修改过密码，请修改密码！')){location.href = "changepass.html";}
					}
					//geterweima(uid);//加载绑定微信二维码
					var bindWechat = data.isBindWechat || '';
					//判断是否绑定过微信
					if(bindWechat != 1){$('#bindWeixin').show();}else{$('#unbindWeixin').show();}
					//左侧菜单
					var html = '';
					var con = data.privileges || [];
					var isa = 0;
					for(var i=0,len=con.length;i<len;i++){
						var d = con[i] || '';
						var id = d.id || '';
						var pid = d.pid || '';
						var name = d.name || '';//名称
						var type = d.type || '';//
						var value = d.value || '';//
						var url = d.url || '';//
						var state = d.state || '';//
						var state_str = d.state_str || '';//
						var level = d.level || '';
						var lstr = '';
						switch(level){
							case 1:lstr = 'c1';isa++;break;
							case 2:lstr = 'c2';break;
							case 3:lstr = 'c3';break;
							default:break;
						}
						if(type == '按钮' && value != ''){//存储按钮权限值 集合
							g.serTT = g.serTT != '' ? g.serTT + ',' + value : value;
						}
						if(type == '按钮'){continue;}
						if(type == '菜单' && name == '工作台'){continue;}//过滤菜单工作台
						if(type == '菜单' && name == '数据统计'){continue;}//过滤菜单数据统计
						if(type == '菜单' && name == '任务墙'){continue;}//过滤菜单
						if(name == '稽查任务'){//判断加载稽查任务页面
							lstr += ' JiChaRenWuBtn ';
							if(g.page == 'renwu'){lstr += ' active ';$('#iframeObj').attr('src',value);}
							if(g.page == 'jichamokuai'){lstr += ' active ';$('#iframeObj').attr('src','稽查模块.html');}
							if(g.page == 'jichafaxian'){lstr += ' active ';$('#iframeObj').attr('src','稽查发现.html');}
							if(g.page == 'binglijicha'){lstr += ' active ';$('#iframeObj').attr('src','病例稽查.html');}
						}
						if(name == '单中心报告评审'){//判断加载稽查任务页面
							lstr += ' danzhognxinbaobtn ';
							if(g.page == 'pingshen'){lstr += ' active ';$('#iframeObj').attr('src',value);}
						}
						if(name == '在线评审'){//判断加载稽查任务页面
							lstr += ' zaixianpingshenbtn ';
							if(g.page == 'zaixianpingshen'){lstr += ' active ';$('#iframeObj').attr('src',value);}
						}
						
						var icostr = level == 1 ? '<i class="left_ico type'+isa+'"></i>' : '';
						html+='<div id="'+id+'" pid="'+pid+'" url="'+value+'" class="mm '+lstr+'">'+icostr+'<span class="text_c">'+name+'</span></div>';	
					}
					Utils.offLineStore.set("serTT",g.serTT,false);//权限存储
					$('#scrollbarList').html(html);
					//if(g.page == 'renwu'){$('.JiChaRenWuBtn').click();}
					menuFunction();
					//loadWork();//加载工作台
				}
				else{
					var msg = data.message || "失败";
					//Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  //Utils.alert("超时");
		　　　　}
			}
		});
	}
	
	//加载绑定微信二维码
	function geterweima(uid){
	
		var obj = new WxLogin({
		  id:"login_container", 
		  appid: "wxb9b0badbc053646e", 
		  scope: "snsapi_login", 
		  redirect_uri: Base.http3,
		  style: "white",
		  href: "",
		  state:uid,
		  response_type:"code"
		});
	}
	//微信绑定
	function bindWeixinFunc(){
		$('.stip_bg2').show();
		$('#login_container').fadeIn();
	}
	//解除微信绑定
	function unbindWeixinFunc(){
		if(!confirm('确认解绑微信吗？')){return false;}
		var condi = {};
		var url = Base.serverUrl + "user/unbind";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"POST",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					Utils.alert('解绑成功！');
					$('#bindWeixin').show();
					$('#unbindWeixin').hide();
				}
				else{
					var msg = data.message || "失败";
					Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  //Utils.alert("超时");
		　　　　}
			}
		});
	}
	//隐藏二维码
	$('.stip_bg').on('click',function(){
		$('.stip_bg2').fadeOut(200);
		$('#login_container').hide();
	});
	

	
	//退出
	function loginOutFunc(){
		
		//location.href= Base.serverUrl + "logout";
		
		//Utils.alert('功能正在开发！');return false;
		if(!confirm('确认退出吗？')){return false;}
		var condi = {};
		var url = Base.serverUrl + "logout";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"POST",
			xhrFields: {
				withCredentials: true
			},
			beforeSend: function(xhr) {
				xhr.setRequestHeader('JWCQ', 'JWCQ');
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					Utils.alert('退出成功！');
					
				}
				else{
					var msg = data.message || "退出失败";
					//Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  //Utils.alert("超时");
		　　　　}
			}
		});
	}
		

	//获取所有菜单
	function getAllMenu(){
		var condi = {};
		condi.page = g.nowPage;//当前页
		condi.number = 1000;//每页显示行数
		var url = Base.serverUrl + "privilege/getAll";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"GET",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					var data = data.result || [];
					var html = '';
					var con = data || [];
					for(var i=0,len=con.length;i<len;i++){
						var d = con[i] || '';
						var id = d.id || '';
						var pid = d.pid || '';
						var name = d.name || '';//名称
						var type = d.type || '';//
						var value = d.value || '';//
						var url = d.url || '';//
						var state = d.state || '';//
						var state_str = d.state_str || '';//
						var level = d.level || '';
						var lstr = '';
						switch(level){
							case 1:lstr = 'c1';break;
							case 2:lstr = 'c2';break;
							case 3:lstr = 'c3';break;
							default:break;
						}
						if(name == '稽查任务'){lstr += ' JiChaRenWuBtn ';}
						html+='<div id="'+id+'" pid="'+pid+'" url="'+value+'" class="mm '+lstr+'"><span class="text_c">'+name+'</span></div>';	
					}	
					$('#scrollbarList').html(html);
					menuFunction();
				}
				else{
					var msg = data.message || "获取菜单失败";
					//Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  //Utils.alert("超时");
		　　　　}
			}
		});
	}
	
	//公共左侧菜单展开与收
	function menuFunction(){
		//var obj = $('#common_menu') || {};
		var obj = $('#scrollbarList') || {};
		if(!obj){Utils.alert("左侧公共菜单ID不存在"); return false;}
		//判断当前菜单有否有子菜单
		$('.mm').each(function(){
			var _is = $(this) || {};
			if(_is.hasClass('c1') && _is.next().hasClass('c2') || _is.hasClass('c2') && _is.next().hasClass('c3') ){
				_is.addClass('has');
			}else{
				_is.removeClass('has');
			}
			
		});
		//一级菜单点击
		obj.find('.c1').on('click',function(){
			var _this = $(this) || {};
			var _id = _this.attr('id') || '';
			var _e = _this.find('.text_c').html() || '';
			var _url = _this.attr('url') || '';
			//$('#menu_show_t .ss').removeClass('active');
			//$('#menu_show_t .ss').html('');
			//$('#menu_show_t .s0').html(_e).addClass('active');
			if(_id == ''){Utils.alert("当前菜单ID不存在"); return false;}
			if(!_this.next().hasClass('c2')){//判断当前菜单为直接链接地址
				$('.mm').removeClass('active');
				_this.addClass('active');
				if(_url != ''){
					if(_url == '稽查任务.html'){window.open('http://118.190.132.68:8080/html/home.html');return false;}
					document.getElementById("iframeObj").src = _url ;
				}//跳转
				return false;
			}
			obj.find('.c2').each(function(n){
				var _t = $(this) || {};
				var _pid = _t.attr('pid') || '';
				if(_pid == _id){
					if(_this.hasClass('down')){
						_t.slideUp(200);
					}
					else{
						_t.slideDown(200);
					}
					if(_t.hasClass('c2') && _t.next().hasClass('c3')){//判断是当前菜单的是否有子元素
						var _id2 = _t.attr('id') || '';
						obj.find('.c3').each(function(n){
							var _t2 = $(this) || {};
							var _pid2 = _t2.attr('pid') || '';
							if(_pid2 == _id2 && _this.hasClass('down')){_t2.slideUp(200);}
						});
					}
				}
			});
			_this.toggleClass('down');
		});
		//二级菜单点击
		obj.find('.c2').on('click',function(){
			var _this = $(this) || {};
			var _id = _this.attr('id') || '';
			var _pid = _this.attr('pid') || '';
			var _e = _this.find('.text_c').html() || '';
			var _e2 = $('#'+_pid).find('.text_c').html() || '';
			var _url = _this.attr('url') || '';
			//$('#menu_show_t .ss').removeClass('active');
			//$('#menu_show_t .ss').html('');
			//$('#menu_show_t .s0').html(_e2);
			//$('#menu_show_t .s1').html(' > '+_e).addClass('active');
			if(_id == ''){Utils.alert("当前菜单ID不存在"); return false;}
			if(!_this.next().hasClass('c3')){
				$('.mm').removeClass('active');
				_this.addClass('active');
				if(_url != ''){
					if(_url == '稽查任务.html'){window.open('http://118.190.132.68:8080/html/home.html');return false;}
					document.getElementById("iframeObj").src = _url ;
				}//跳转
				return false;
			}
			if(_this.next().hasClass('c3')){//判断是当前菜单的是否有子元素
				obj.find('.c3').each(function(n){
					var _t2 = $(this) || {};
					var _pid2 = _t2.attr('pid') || '';
					if(_pid2 == _id){_t2.slideToggle(200);}
				});
			}
			_this.toggleClass('down');
		});
		//三级菜单点击
		obj.find('.c3').on('click',function(){
			var _this = $(this) || {};
			var _pid = _this.attr('pid') || '';
			var _pid2 = $('#'+_pid).attr('pid') || '';
			var _e = _this.find('.text_c').html() || '';
			var _e2 = $('#'+_pid).find('.text_c').html() || '';
			var _e3 = $('#'+_pid2).find('.text_c').html() || '';
			var _url = _this.attr('url') || '';
			//$('#menu_show_t .ss').removeClass('active');
			//$('#menu_show_t .ss').html('');
			//$('#menu_show_t .s0').html(_e3);
			//$('#menu_show_t .s1').html(' > '+_e2);
			//$('#menu_show_t .s2').html(' > '+_e).addClass('active');
			$('.mm').removeClass('active');_this.addClass('active');
			if(_url != ''){
				if(_url == '稽查任务.html'){window.open('http://118.190.132.68:8080/html/home.html');return false;}
				document.getElementById("iframeObj").src = _url ;
			}//跳转
		});
	}
	
	
	
});	
</script>
</body>
</html>