<!doctype html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta content="IE=Edge,chrome=1" http-equiv="X-UA-Compatible">
	<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
	<meta content="yes" name="apple-mobile-web-app-capable">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="format-detection" content="telephone=no"/>
	<!-- <link rel="stylesheet" href="../public/libs/bootstrap/bootstrap.min.css" /> -->
	<!-- <link rel="stylesheet" href="../public/libs/bootstrap/bootstrap-select.css" /> -->
	<link rel="stylesheet" href="../public/select2/css/select2.min.css" />
	<link rel="stylesheet" href="../public/css/common.css" />
	<link rel="stylesheet" href="../public/btncss/normalize.css" />
	<link rel="stylesheet" href="../public/btncss/vicons-font.css" />
	<!-- <link rel="stylesheet" href="../public/btncss/base.css" /> -->
	<link rel="stylesheet" href="../public/btncss/buttons.css" />
	<title></title>
	<style>
		.check_box .i, .check_box2 .i{margin-right:5px;}
	</style>
</head>
<body class="xiangmuguanli xiangmujibenxinxi">
	<!-- 委托方 -->
	<ul style="width:356px;" class="choiseDanwei choiseDanwei4">
		<li>加载失败</li>
	</ul>
	<!-- 协同项目经理 -->
	<ul style="width:356px;" class="choiseDanwei choiseDanwei10">
		<li>加载失败</li>
	</ul>
	<!-- 商务经理 -->
	<ul style="width:356px;" class="choiseDanwei choiseDanwei101">
		<li>加载失败</li>
	</ul>
	<!-- 项目经理 -->
	<ul style="width:356px;" class="choiseDanwei choiseDanwei102">
		<li>加载失败</li>
	</ul>	
	<h4 class="page_title">项目基本信息
		<a href="javascript:;" id="editBtn" class="creat_forse">编辑</a>
		<a href="javascript:;" style="display:none;" id="change_ok_btn" class="creat_forse">保存</a>
		<a href="javascript:;" style="display:none;" id="change_no_btn" class="creat_forse type1">取消</a>
	</h4>
	<div class="content_box1">
		<div class="con_d"><span class="lable need">委托方</span><i class="x">*</i>
			<input id="sponsor_name" class="common_input common_inputr readonly1" type="text" />编号：<span id="sponsor_code"></span>
			<a href="javascript:;" id="downloadit" style="float:none;margin-left:12px;" class="creat_forse">下载合同模板</a>
			<!-- &nbsp;&nbsp;&nbsp;&nbsp; -->
			<!-- 联系人：<span>0068</span>&nbsp;&nbsp;&nbsp;&nbsp; -->
			<!-- 联系电话：<span>0068</span> -->
		</div>
		<div id="pronumhide" class="con_d"><span class="lable need">项目编号</span><i class="x">*</i><input id="pro_number" class="common_input" type="text" /></div>
		<div class="con_d"><span class="lable need">CRO名称</span><i class="x">*</i><input id="cro_name" class="common_input" type="text" /></div>
		<div class="con_d"><span class="lable need">项目名称/题目</span><i class="x">*</i><input id="name" class="common_input" type="text" /></div>
		<div class="con_d"><span class="lable need">药物/器械名称</span><i class="x">*</i><input id="medicine" class="common_input" type="text" /></div>
		<div class="con_d"><span class="lable need">试验类型</span><i class="x">*</i><input id="shiyantype" class="common_input" type="text" /></div>
		<div class="con_d"><span class="lable need">适应症</span><i class="x">*</i><input id="indication" class="common_input" type="text" /></div>
		<div class="con_d"><span class="lable need">注册分类</span><i class="x">*</i><input id="classification" class="common_input" type="text" /></div>
		<div class="con_d"><span class="lable need">项目类型</span><i class="x">*</i><select id="audit_type" class="common_select">
				<option value="">请选择</option>
				<option value="单次稽查">单次稽查</option>
				<option value="全过程控制">全过程控制</option>
				<option value="自查">自查</option>
				<option value="质控">质控</option>
				<option value="过程稽查">过程稽查</option>
			</select>
		</div>
		<div id="project_staging" class="con_d"><span class="lable need">项目分期</span><i class="x">*</i>
			<div class="check_box"><i class="i"></i>BE</div>
			<div class="check_box"><i class="i"></i>PK/PD</div>
			<!-- <div class="check_box yiqishow"><i class="i"></i>I期</div> -->
			<div class="check_box"><i class="i"></i>I期</div>
			<div class="check_box"><i class="i"></i>Ia期</div>
			<div class="check_box"><i class="i"></i>Ib期</div>
			<div class="check_box"><i class="i"></i>II期</div>
			<div class="check_box"><i class="i"></i>IIa期</div><br>
			<span class="lable need"></span><i class="x"></i>
			<div class="check_box"><i class="i"></i>IIb期</div>
			<div class="check_box"><i class="i"></i>III期</div>
			<div class="check_box"><i class="i"></i>IIIa期</div>
			<div class="check_box"><i class="i"></i>IIIb期</div>
			<div class="check_box"><i class="i"></i>IV期</div>
			<div class="check_box"><i class="i"></i>研究者发起</div>
		</div>
		<div id="yiqiShow" class="con_d">
			<span class="lable">数据管理单位</span><i class="x">*</i><input id="data_manager_center" class="common_input common_input3" type="text" />
			<span class="lable lable2">中心实验室</span><i class="x">*</i><input id="center_lab" class="common_input common_input3" type="text" />
		</div>
		<div class="con_d">
			<span class="lable">统计分析单位</span><i class="x">*</i><input id="data_analysis_center" class="common_input common_input3" type="text" />
		</div>
		<div class="con_d">
			<span class="lable">方案编号</span><i class="x">*</i><input id="fanganbianhao_val" class="common_input common_input3" type="text" />
		</div>
		<div class="con_d">
			<span class="lable">《试验方案》版本号</span><i class="x">*</i><input id="experimental_program_version" class="common_input common_input3" type="text" />
			<span class="lable lable2">版本日期</span><i class="x"></i><input id="experimental_program_date" class="common_input common_input3" type="text" />
		</div>
		<div class="con_d">
			<span class="lable">项目SOP版本号</span><i class="x">*</i><input id="sop_version" class="common_input common_input3" type="text" />
			<span class="lable lable2">版本日期</span><i class="x"></i><input id="sop_date" class="common_input common_input3" type="text" />
		</div>
		
		<div class="con_d"><span class="lable need">项目启动函</span><i class="x">*</i><textarea id="start_up_letter" style="height:500px;" class="common_textarea"></textarea></div>
		<div class="con_d">
			<span class="lable">受托方</span><i class="x"></i><input id="agent" readonly class="common_input common_input3 readonly1 readonly" type="text" />
			<span class="lable lable2">地址</span><i class="x"></i><input id="agent_address" readonly class="common_input common_input3 readonly1 readonly" type="text" />
		</div>
		<div class="con_d">
			<span class="lable">联系方式</span><i class="x"></i><input id="agent_contact" readonly class="common_input common_input3 readonly1 readonly" type="text" />
			<span class="lable lable2">手机</span><i class="x"></i><input id="agent_phone" readonly class="common_input common_input3 readonly1 readonly" type="text" />
		</div>
		<div class="con_d">
			<span class="lable">微信公众号</span><i class="x"></i><input id="agent_wechat" readonly class="common_input common_input3 readonly1 readonly" type="text" />
			<span class="lable lable2">网址</span><i class="x"></i><input id="agent_weburl" readonly class="common_input common_input3 readonly1 readonly" type="text" />
		</div>
		<div class="con_d">
			<span class="lable need">商务经理</span><i class="x">*</i><input id="business_manager_name" class="common_input" type="text" />
		</div>
		<div class="con_d">
			<span class="lable need">项目经理</span><i class="x">*</i><input id="project_manager_name" class="common_input" type="text" />
			<div style="display:inline;">
				<a href="javascript:;" id="fabuAbtn" style="margin-left:10px;float:none;display:none;" class="creat_forse type2 xiangMu_xiangMuFaBu">发布</a>
				<a href="javascript:;" id="fabuing" style="float:none;display:none;" class="creat_forse">发布中</a>
				<a href="javascript:;" id="fabu_down" style="float:none;display:none;" class="creat_forse type1">已完成</a>
			</div>
		</div>
		<div class="con_d">
			<span class="lable need">协同项目经理</span><i class="x"></i>
			<!-- <input id="xiangmuzhuli" class="common_input" type="text" /> -->
			<select id="xiangmuzhuli" multiple class="common_select">
				<option value="">加载失败</option>
			</select>
		</div>
		<div class="con_d"><span class="lable need">备注</span><i class="x"></i><textarea id="beizhur" class="common_textarea"></textarea></div>
		<!-- <div class="con_d">
			<span class="lable need">项目助理</span><i class="x"></i>
			
			<select id="xiangmuzhuli2" multiple class="common_select">
				<option value="">加载失败</option>
			</select>
		</div> -->
		<div id="new_create_btn" style="display:none;" class="btns_div"><a back='项目管理.html' class="common_abtn goback type1">取消</a><a href="javascript:;" id="create_new_btn" class="common_abtn type2">创建</a></div>
	</div>
	<div info='新建时隐藏' class="new_div_hide">
	<div class="line_bg"></div>
	<h4 class="page_title">目的范围依据</h4>
	<div class="content_box2">
		<div class="con_d"><span class="lable">稽查目的</span><textarea id="audit_aim" class="common_textarea"></textarea></div>
		<div class="con_d"><span class="lable">稽查范围</span><textarea id="audit_scope" class="common_textarea"></textarea></div>
		<div class="con_d"><span class="lable">稽查依据</span><textarea id="audit_reference" class="common_textarea"></textarea></div>
		
	</div>
	<div class="line_bg"></div>
	<h4 class="page_title">稽查模块</h4>
	<div class="content_box3">	
		<div id="audit_module" class="check_div">
			<!-- <div class="check_box active"><i class="i"></i>项目简介</div>
			<div class="check_box active"><i class="i"></i>保密性</div>
			<div class="check_box active"><i class="i"></i>人员</div>
			<div class="check_box active"><i class="i"></i>人员访谈</div>
			<div class="check_box active"><i class="i"></i>伦理</div>
			<div class="check_box active"><i class="i"></i>基本文件</div>
			<div class="check_box active"><i class="i"></i>设施设备</div>
			<div class="check_box active"><i class="i"></i>试验用药品/器械</div>
			<div class="check_box active"><i class="i"></i>生物样本/实验室</div>
			<div class="check_box active"><i class="i"></i>质量管理</div>
			<div class="check_box active"><i class="i"></i>研究者职责</div>
			<div class="check_box active"><i class="i"></i>申办方/CRO职责</div>
			<div class="check_box active"><i class="i"></i>药物安全/警戒</div>
			<div class="check_box active"><i class="i"></i>数据管理与生物统计</div>
			<div class="check_box active"><i class="i"></i>电子系统</div>
			<div class="check_box active"><i class="i"></i>稽查总结会议</div>
			<div class="check_box active"><i class="i"></i>其他</div> -->
		</div>
		<!-- <div class="btns_div"><a back='项目管理.html' class="common_abtn goback type1">取消</a><a href="javascript:;" id="change_ok_btn" class="common_abtn type2">保存</a></div> -->
	</div>
	<div class="line_bg"></div>
	<h4 class="page_title">项目状态</h4>
	<div class="content_box4">
		<span id="state" class="report_sta">稽查进行中</span>
		<a href="javascript:;" style="display:none;" class="report_set set_cancel">设置项目取消</a>
		<a href="javascript:;" style="display:none;" class="report_set set_reset">恢复项目</a>
	</div>
	</div>
	
	
	
	<!-- 弹窗 -->
	<div info="弹窗背景" class="stip_bg"></div>
	<div info="弹窗容器" class="stip_box">
		<div class="stip_content">
		
			<div class="sbox xiangmufabuSbox">
				<h4 class="sbox_h4">项目发布</h4>
				<div class="sbox_c">
					<span class="slable">发布说明</span><i class="star"></i>
					<textarea id="fabutext" style="height:75px;" class="sbox_input"></textarea>
				</div>
				<div class="sbox_btn_div" style="text-align:center;">
					<a href="javascript:;" id="noBtn" onclick="closeSbox()" class="sbox_btn btn1">取消</a>
					<a id="yesBtn" style="margin-left:25px;" href="javascript:;" class="sbox_btn btn2">确认</a>
				</div>
			</div>
		</div>
	</div>
	
	
	
	<script type="text/javascript" src="../public/libs/jquery.min.js"></script>
	<script type="text/javascript" src="../public/laydate/laydate.js"></script>
	<script type="text/javascript" src="../public/libs/json.js"></script>
	<script type="text/javascript" src="../public/libs/base.js"></script>
	<script type="text/javascript" src="../public/libs/layer.js"></script>
	<script type="text/javascript" src="../public/libs/utils.js"></script>
	<script type="text/javascript" src="../public/js/common2.js"></script>
	<script type="text/javascript" src="../public/select2/js/select2.full.min.js"></script>
	<script type="text/javascript" src="../public/select2/js/i18n/zh-CN.js"></script>
	<!-- <script type="text/javascript" src="../public/js/index.js"></script> -->
	
</body>
<script>
$(function(){
	var g = {};
	g.login_token = Utils.offLineStore.get("token",false) || "";
	g.id = Utils.getQueryString("id") || "";//获取项目id
	g.do = Utils.getQueryString("do") || "";//获取操作 是查看（check）还是修改（change）新建 （new）
	g.httpTip = new Utils.httpTip({});
	g.totalPage = 1;//存总页数
	g.nowPage = 0;//存当前页 0 是第一页
	g.showPages = 10;//每页显示多少行
	g.loadPage = true;//判断页面刚加载一次 定义分页的地方用
	
/* **************************************** lodding ******************************************** */	
	//加载顶部标题
	$('#menu_show_t .ss',parent.document).removeClass('active').html('');
	$('#menu_show_t .s0',parent.document).css('cursor','pointer').html('项目管理').off().on('click',function(){
		parent.document.getElementById("iframeObj").src = '项目管理.html';
	});
	$('#menu_show_t .s1',parent.document).html(' > 项目基本信息').addClass('active');
	
	$('#editBtn').on('click',editStatic);//进入编辑状态
	$('#downloadit').on('click',downloaditFunc);//下载合同模板
	$('#change_ok_btn').on('click',function(){changeOrCreateProject(1)});
	$('.set_cancel').on('click',cancelPro);
	$('.set_reset').on('click',resetPro);
	$('.yiqishow').on('click',yiqiISShow);
	//发布项目
	$('#fabuAbtn').on('click',function(){
		$('.xiangmufabuSbox input,.xiangmufabuSbox textarea').val('').removeClass('readonly').removeAttr('readonly');//清空弹窗
		$('.xiangmufabuSbox select').val('');//清空弹窗
		showSbox('.xiangmufabuSbox');//显示弹窗
		$('#yesBtn').off().on('click',fabuAbtnFunc);
	});
	$('#create_new_btn').on('click',function(){changeOrCreateProject(2)});
	getjichamokuai();//获取稽查模块
	getShenBanFang();//加载申办方列表
	
	
/* **************************************** setTing ******************************************** */	
	
	//setSearchRole('.choiseDanwei102','项目经理','li');//给项目经理 选框赋值
	setGetSearchInput('#project_manager_name','.choiseDanwei102');//定义可以搜索下拉的
	setSearchBuMen('.choiseDanwei102','稽查部','li');//给项目成员 选框赋值
	//setSearchRole('#xiangmuzhuli','协同项目经理','option','name');//给协同项目经理 选框赋值
	setSearchBuMen('#xiangmuzhuli','稽查部','option','name');//给项目成员 选框赋值
	//setSearchBuMen('#xiangmuzhuli2','稽查部','option','name');//给项目成员 选框赋值
	//setSearchRole('.choiseDanwei10','协同项目经理','li');//给协同项目经理 选框赋值
	//setGetSearchInput('#xiangmuzhuli','.choiseDanwei10');//定义可以搜索下拉的
	setSearchRole('.choiseDanwei101','商务经理','li');//给商务经理 选框赋值
	setGetSearchInput('#business_manager_name','.choiseDanwei101');//定义可以搜索下拉的
	//setMoreSlide('#xiangmuzhuli','.choiseDanwei10');//定义可以多选
	//定义控件
	$("#xiangmuzhuli").select2({tags: true});
	//$("#xiangmuzhuli2").select2({tags: true});
	loadCheck();//判断编辑还是查看
	is_show('.xiangMu_xiangMuFaBu');
	
	
	//下载合同模板
	function downloaditFunc(){
		var url = Base.serverUrl + 'project/exportContact?id='+g.id;
		window.open(url);
		
	}
	
	//发布项目经理职位 项目发布
	function fabuAbtnFunc(){
		var fabutext = $('#fabutext').val() || '';
		//if(fabutext == ''){Utils.alert('发布说明不能为空！');return false;}
		var condi = {};
		//condi.page = g.nowPage;//当前页
		condi.projectId = g.id;
		condi.description = fabutext;
		condi.number = 1000;//每页显示行数
		var url = Base.serverUrl + "publish/task/addProject";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"POST",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					var data = data.result || [];
					Utils.alert('发布成功！');
					getProject();//获取项目信息
					closeSbox();
				}
				else{
					var msg = data.message || "发布失败";
					Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  //Utils.alert("超时");
		　　　　}
			}
		});
	}
	//获取稽查模块
	function getjichamokuai(){
		var condi = {};
		//condi.page = g.nowPage;//当前页
		condi.number = 1000;//每页显示行数
		var url = Base.serverUrl + "module/search";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"POST",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					var data = data.result || [];
					var con = data.content || [];
					var html = '';
					for(var i=0,len=con.length;i<len;i++){
						var d = con[i] || '';
						var id = d.id || '';
						var code = d.code || '';//编号
						var name = d.name || '';//名称
						var templet = d.templet || '';//模块的模板
						html+='<div class="check_box active"><i class="i"></i>'+name+'</div>';
					}
					$('#audit_module').html(html);
				}
				else{
					var msg = data.message || "获取失败";
					//Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  //Utils.alert("超时");
		　　　　}
			}
		});
	}
	
	
	//取消保存按钮
	$('#change_no_btn').on('click',function(){
		g.do = 'check';
		loadCheck();
	});
	//获取受托方信息
	function shoutuofangShow(){
		var condi = {};
		var url = Base.serverUrl + "static/company/info/get";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"POST",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					var d = data.result || [];
					g.id = d.id || '';
					$('#agent').val(d.name || '');
					$('#agent_address').val(d.address || '');
					$('#agent_contact').val(d.contact || '');
					$('#agent_phone').val(d.phone || '');
					$('#agent_wechat').val(d.wechat || '');
					$('#agent_weburl').val(d.weburl || '');
				}
				else{
					var msg = data.message || "获取失败";
					//Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  //Utils.alert("超时");
		　　　　}
			}
		});
	}

	//获取目的范围依据
	function mudifanweiShow(){
		var condi = {};
		var url = Base.serverUrl + "static/target_scope_reference/get";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"POST",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					var data = data.result || [];
					var content1 = data.target || '';
					var content2 = data.scope || '';
					var content3 = data.reference || '';
					$('#audit_aim').val(content1);
					$('#audit_scope').val(content2);
					$('#audit_reference').val(content3);
					
				}
				else{
					var msg = data.message || "获取失败";
					//Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  //Utils.alert("超时");
		　　　　}
			}
		});
	}

	//判断是否显示 中心实验室和检测单位
	function yiqiISShow(){
		if($('.yiqishow').hasClass('active')){
			$('#yiqiShow').slideDown();
		}else{
			$('#yiqiShow').slideUp();
		}
	}
	//取消项目
	function cancelPro(){
		if(!confirm('确认取消项目吗？')){return false;}
		var condi = {};
		condi.id = g.id;
		var url = Base.serverUrl + "project/cancel";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"POST",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					Utils.alert('取消成功！');
					getProject();//获取项目信息
				}
				else{
					var msg = data.message || "取消失败";
					Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  Utils.alert("超时");
		　　　　}
			}
		});
	}
	//恢复项目
	function resetPro(){
		if(!confirm('确认恢复项目吗？')){return false;}
		//Utils.alert('正在开发中！');return false;
		var condi = {};
		condi.id = g.id;
		var url = Base.serverUrl + "project/restore";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"POST",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					Utils.alert('恢复成功！');
					getProject();//获取项目信息
				}
				else{
					var msg = data.message || "恢复失败";
					Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  Utils.alert("超时");
		　　　　}
			}
		});
	}
	//编辑状态
	function editStatic(){
		g.do = 'change';
		loadCheck();
	}
	
	//判断是编辑还是查看
	function loadCheck(){
		if(g.do == 'check'){//查看
			$('input,textarea').attr('readonly',true).addClass('readonly');
			$('select').attr('disabled',true).addClass('readonly');
			$('#change_ok_btn').hide();//修改保存按钮
			$('#change_no_btn').hide();//修改取消按钮
			$('#editBtn').show();//编辑按钮
			//$('.set_cancel').hide();//取消项目按钮
			//$('.set_reset').hide();//恢复项目按钮
			getProject();//获取项目信息
			$('#new_create_btn').remove();
			//定义选择分期 只能单选
			$('.check_box').off();
			$('.xiangmuguanli').off('click','.check_box');
			$('.xiangmuguanli').off('click','#project_staging .check_box');
		}else if(g.do == 'change'){//修改
			$('#editBtn').hide();//编辑按钮
			$('#change_ok_btn').show();//修改保存按钮
			$('#change_no_btn').show();//修改取消按钮
			//$('.set_cancel.active').show();//取消项目按钮
			//$('.set_reset.active').show();//恢复项目按钮
			$('.check_box').each(function(){//复选框
				var _this = $(this) || {};
				_this.off().on('click',function(){
					if(_this.hasClass('active')){_this.removeClass('active');
					}else{_this.addClass('active')}
					//if(_this.hasClass('yiqishow')){yiqiISShow();}
				});
			});
			$('input,textarea').attr('readonly',false).removeClass('readonly');
			$('select').attr('disabled',false).removeClass('readonly');
			$('.readonly1').off().attr('readonly',true).addClass('readonly');
			$('#new_create_btn').remove();
			getProject();//获取项目信息
			//定义选择分期 只能单选
			$('.xiangmuguanli').off('click','#project_staging .check_box').on('click','#project_staging .check_box',function(){
				$(this).addClass('active').siblings('.check_box').removeClass('active');
			});
		}else if(g.do == 'new'){//新建
			$('#new_create_btn').show();
			$('#pronumhide').remove();//项目编号
			$('.new_div_hide').remove();//编辑按钮
			$('#editBtn').remove();
			shoutuofangShow();//获取受托方信息
			//定义选择分期 只能单选
			$('.xiangmuguanli').off('click','#project_staging .check_box').on('click','#project_staging .check_box',function(){
				$(this).addClass('active').siblings('.check_box').removeClass('active');
			});
		}
	}
	
	
	//修改保存项目信息
	function changeOrCreateProject(is){
		var is = is || '';//is 1 修改或保存 2 新建
		var sponsor_name = $('#sponsor_name').val() || '';
		var sponsor_code = $('#sponsor_code').html() || '';
		var sponsor_id = $('#sponsor_name').attr('sid') || '';
		var cro_name = $('#cro_name').val() || '';
		var pro_number = $('#pro_number').val() || '';
		var name = $('#name').val() || '';
		var medicine = $('#medicine').val() || '';
		var shiyantype = $('#shiyantype').val() || '';
		var indication = $('#indication').val() || '';
		var classification = $('#classification').val() || '';
		var audit_type = $('#audit_type').val() || '';
		var project_staging = setGetCheckValue('#project_staging');
		var center_lab = $('#center_lab').val() || '';
		var data_analysis_center = $('#data_analysis_center').val() || '';
		var fanganbianhao_val = $('#fanganbianhao_val').val() || '';
		var data_manager_center = $('#data_manager_center').val() || '';
		//var test_institution = $('#test_institution').val() || '';
		var experimental_program_version = $('#experimental_program_version').val() || '';
		var experimental_program_date = $('#experimental_program_date').val() || '';
		var sop_version = $('#sop_version').val() || '';
		var sop_date = $('#sop_date').val() || '';
		var start_up_letter = $('#start_up_letter').val() || '';
		var agent = $('#agent').val() || '';
		var agent_address = $('#agent_address').val() || '';
		var agent_contact = $('#agent_contact').val() || '';
		var agent_phone = $('#agent_phone').val() || '';
		var agent_wechat = $('#agent_wechat').val() || '';
		var agent_weburl = $('#agent_weburl').val() || '';
		var business_manager_name = $('#business_manager_name').val() || '';
		var project_manager_name = $('#project_manager_name').val() || '';
		var beizhur = $('#beizhur').val() || '';
		//var xiangmuzhuli = $('#xiangmuzhuli option:selected').text() || '';
		var xiangmuzhuli = $('#xiangmuzhuli').val() || '';
		//var xiangmuzhuli2 = $('#xiangmuzhuli2').val() || '';
		var audit_aim = $('#audit_aim').val() || '';
		var audit_scope = $('#audit_scope').val() || '';
		var audit_reference = $('#audit_reference').val() || '';
		var audit_module = setGetCheckValue('#audit_module');
		//遍历找出不允许为空项 为空提示
		var tips = '';
		$('.con_d').each(function(){//循环所有框
			var _t = $(this) || {};
			var _o = _t.find('.x') || [];
			if(tips != ''){return false;}//跳出循环
			if(_t.css('display') == 'none'){return true;}//隐藏的 跳出本次循环
			if(_o.length > 0){
				_o.each(function(){//循环所有必填标志
					var _ti = $(this) || {};
					var _next = _ti.next().val() || '';
					var _prev = _ti.prev().html() || '';
					var tr = _ti.parents('.con_d').find('.check_box').hasClass('active') ? false : true;
					if(_ti.html() != '' && _ti.next().hasClass('check_box') && tr){//复选框 查找是否有active 判断有没有选中的
						tips = _prev;return false;//跳出循环 如果是复选框 查找是否有active 判断有没有选中的
					}
					if(_ti.html() != '' && _next == '' && !_ti.next().hasClass('check_box')){
						tips = _prev;return false;//跳出循环
					}
				});
			}
		});
		var xiangmuzhuli = xiangmuzhuli.length > 0 ? xiangmuzhuli.join(',') : xiangmuzhuli[0] || '';
		//var xiangmuzhuli2 = xiangmuzhuli2.length > 0 ? xiangmuzhuli2.join(',') : xiangmuzhuli2[0] || '';
		
		if(tips != ''){Utils.alert(tips+'不能为空！');return false;}
		var condi = {};
		condi.sponsor_name = sponsor_name;
		condi.sponsor_id = sponsor_id;
		condi.sponsor_code = sponsor_code;
		condi.cro_name = cro_name;
		condi.code = pro_number;
		condi.name = name;
		condi.medicine = medicine;
		condi.experimentalType = shiyantype;
		condi.indication = indication;
		condi.classification = classification;
		condi.audit_type = audit_type;
		condi.project_staging = project_staging;
		condi.center_lab = center_lab;
		condi.data_analysis_center = data_analysis_center;
		condi.plan_code = fanganbianhao_val;
		condi.data_manager_center = data_manager_center;
		//condi.test_institution = test_institution;
		condi.experimental_program_version = experimental_program_version;
		condi.experimental_program_date = experimental_program_date;
		condi.sop_version = sop_version;
		condi.sop_date = sop_date;
		condi.start_up_letter = start_up_letter;
		condi.agent = agent;
		condi.agent_address = agent_address;
		condi.agent_contact = agent_contact;
		condi.agent_phone = agent_phone;
		condi.agent_wechat = agent_wechat;
		condi.agent_weburl = agent_weburl;
		condi.business_manager_name = business_manager_name;
		condi.project_manager_name = project_manager_name;
		condi.project_assist_manager = xiangmuzhuli;//项目助理
		condi.remarks = beizhur;//
		//condi.project_assist_manager2 = xiangmuzhuli2;//项目助理
		if(is != '2'){//保存
		condi.id = g.id;
		condi.audit_aim = audit_aim;
		condi.audit_scope = audit_scope;
		condi.audit_reference = audit_reference;
		condi.audit_module = audit_module;
		}
		var url = Base.serverUrl + "project/update";
		if(is == '2'){url = Base.serverUrl + "project/create"}
		$('#create_new_btn').off();
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"POST",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					var d = data.result || [];
					var tip = is != '2' ? '保存成功！' : '新建成功！' ;
					Utils.alert(tip);
					if(is == '2'){//新建项目
						setTimeout(function(){
							parent.document.getElementById("iframeObj").src = '项目管理.html';
						},1000);
					}else if(is == '1'){//保存项目
						g.do = 'check';
						loadCheck();
					}
				}
				else{
					var msg = data.message || "保存失败";
					Utils.alert(msg);
					$('#create_new_btn').on('click',function(){changeOrCreateProject(2)});
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				$('#create_new_btn').on('click',function(){changeOrCreateProject(2)});
				if(status=='timeout'){
		　　　　　  Utils.alert("超时");
		　　　　}
			}
		});
	}	
	
	//获取项目信息
	function getProject(){
		var condi = {};
		condi.id = g.id;
		var url = Base.serverUrl + "project/edit";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"POST",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					var d = data.result || [];
					var id = d.id || '';
					$('#sponsor_name').val(d.sponsor_name || '');
					$('#sponsor_code').html(d.sponsor_code || '');
					$('#cro_name').val(d.cro_name || '');
					$('#pro_number').val(d.code || '');
					$('#name').val(d.name || '');
					$('#medicine').val(d.medicine || '');
					$('#shiyantype').val(d.experimentalType || '');
					$('#indication').val(d.indication || '');
					$('#classification').val(d.classification || '');
					$('#audit_type').val(d.audit_type || '');
					setGetCheckValue('#project_staging',(d.project_staging || ''));//项目分期
					$('#center_lab').val(d.center_lab || '');
					$('#data_analysis_center').val(d.data_analysis_center || '');
					$('#fanganbianhao_val').val(d.plan_code || '');
					$('#data_manager_center').val(d.data_manager_center || '');
					//$('#test_institution').val(d.test_institution || '');
					$('#experimental_program_version').val(d.experimental_program_version || '');
					var experimental_program_date = getDate((d.experimental_program_date || ''),'2');
					$('#experimental_program_date').val(experimental_program_date);
					$('#sop_version').val(d.sop_version || '');
					var sop_date = getDate((d.sop_date || ''),'2');
					$('#sop_date').val(sop_date);
					$('#start_up_letter').val(d.start_up_letter || '');
					$('#agent').val(d.agent || '');
					$('#agent_address').val(d.agent_address || '');
					$('#agent_contact').val(d.agent_contact || '');
					$('#agent_phone').val(d.agent_phone || '');
					$('#agent_wechat').val(d.agent_wechat || '');
					$('#agent_weburl').val(d.agent_weburl || '');
					$('#business_manager_name').val(d.business_manager_name || '');
					$('#project_manager_name').val(d.project_manager_name || '');
					//判断发布状态
					var puStatus = d.publishStatus || '';//未发布、报名中、已结束
					$('#fabuAbtn,#fabuing,#fabu_down').hide();
					switch(puStatus){
						case '未发布': $('#fabuAbtn').show();$('#project_manager_name').removeAttr('disabled').removeClass('red');break;
						case '报名中': $('#fabuing').show();$('#project_manager_name').val('发布中').attr('disabled','disabled').addClass('red');break;
						case '已结束': $('#fabu_down').show();$('#project_manager_name').removeAttr('disabled').removeClass('red');break;
						default:break;
					}
					
					$('#beizhur').val(d.remarks || '');
					var ddas = d.project_assist_manager || '';
					var xval = ddas.indexOf(',') > -1 ? ddas.split(',') : ddas;//项目助理的值
					//var xval2 = d.project_assist_manager2.split(',') || '';//项目助理的值
					$('#xiangmuzhuli').attr('disabled',false);
					$('#xiangmuzhuli').val(xval);
					setTimeout(function(){$('#xiangmuzhuli').val(xval).select2()},600);
					
					//$('#xiangmuzhuli2').attr('disabled',false);
					//$('#xiangmuzhuli2').val(xval2).select2();
					//console.log(xval);
					if(g.do == 'check'){$('#xiangmuzhuli').attr('disabled',true);}
					//valchoiseDanwei('.choiseDanwei10',xval);//公共方法 给项目助理弹窗赋值
					var audit_aim = d.audit_aim || '';
					var audit_scope = d.audit_scope || '';
					var audit_reference = d.audit_reference || '';
					if(audit_aim == '' && audit_scope == '' && audit_reference == ''){//判断有没有存储数据
						mudifanweiShow();//获取目的范围依据
					}else{
						$('#audit_aim').val(audit_aim);
						$('#audit_scope').val(audit_scope);
						$('#audit_reference').val(audit_reference);
					}
					setGetCheckValue('#audit_module',(d.audit_module || ''));//稽查模块
					var is_used = d.is_used || '';//判断是否 项目取消
					var state = d.state || '';//项目状态
					var usedStatic = is_used == 0 ? '项目已取消' : state;
					$('#state').html(usedStatic);
					//根据状态修改 项目取消按钮和项目恢复按钮
					if(is_used == 0 && g.do == 'change'){	
						$('.set_reset').show();//取消项目按钮
						$('.set_cancel').hide();//恢复项目按钮
					}else if(is_used != 0 && g.do == 'change'){
						$('.set_cancel').show();//取消项目按钮
						$('.set_reset').hide();//恢复项目按钮
					}else{
						$('.set_cancel').hide();//取消项目按钮
						$('.set_reset').hide();//恢复项目按钮
					}
					
					//yiqiISShow();
					//loadCheck();
				}
				else{
					var msg = data.message || "获取项目信息失败";
					Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  Utils.alert("超时");
		　　　　}
			}
		});
	}

	//关闭弹窗
	$(document).click(function(e){
		$('.choiseDanwei').hide();
		stopPropagation(e);
	});
	
	//输入时搜索申办方
	$("#sponsor_name").keyup(function(){
		var _vth = $(this);
		var _li = $('.choiseDanwei4 li');
		var _val = _vth.val() || '';
		if(_val == '' || _li.length <= 0){return false;}
		_li.show();
		_li.each(function(){//循环搜索
			var _tt = $(this);
			var _val2 = _tt.html() || '';
			var _if = _val2.indexOf(_val);
			if(_if <= -1){//不符合
				_tt.hide();
			}else{_tt.show();}
		});
	});
	//选择申办方
	$("#sponsor_name").click(function(e){
		var _is = $(this);
		var xx = _is.offset().left || 0;
        var yy = _is.offset().top || 0;
		var _top = yy + _is.height() -9;
        $('.choiseDanwei4 li').show();
		$('.choiseDanwei').hide();
		$('.choiseDanwei4').show().css({"left":xx,"top":_top});
		$('.choiseDanwei4 li').on('click',function(e){
			var _tis = $(this);
			var _vdan= _tis.html() || '';
			var _vtip= _tis.attr('tip') || '';
			var sid= _tis.attr('sid') || '';
			_is.val(_vdan);
			_is.attr('sid',sid);
			$('#sponsor_code').html(_vtip);
			_tis.parents('.choiseDanwei').hide();
			stopPropagation(e);
		});
		stopPropagation(e);
    });
	//获取申办方列表
	function getShenBanFang(){
		var condi = {};
		condi.number = 1000;//每页显示行数
		var url = Base.serverUrl + "sponsor/search";
		//g.httpTip.show();
		$.ajax({
			url:url,
			data:condi,
			timeout: 30000, //超时时间设置，单位毫秒
			type:"POST",
			xhrFields: {
				withCredentials: true
			},
			crossDomain: true,
			dataType:'json',
			context:this,
			success: function(data){
				var status = data.success || false;
				if(status){
					var data = data.result || [];
					var data = data.content || [];
					var html = '';
					for(var i=0,len=data.length;i<len;i++){
						var d = data[i] || [];
						var id = d.id || '';
						var name = d.name || '';
						var code = d.code || '';
						html += '<li sid="'+id+'" tip="'+code+'">'+name+'</li>';
					}
					$('.choiseDanwei4').html(html);
				}
				else{
					var msg = data.message || "登录失败";
					Utils.alert(msg);
				}
				//g.httpTip.hide();
			},
			error:function(data,status){
				//g.httpTip.hide();
				if(status=='timeout'){
		　　　　　  Utils.alert("超时");
		　　　　}
			}
		});
	}
	//加载时间控件
	var timeControl1 = {
	  elem: '#experimental_program_date',
	  format: 'YYYY-MM-DD',
	  //min: laydate.now(), //设定最小日期为当前日期
	  max: '2099-06-16', //最大日期
	  istime: true,
	  istoday: false,
	  choose: function(datas){
		 //end.min = datas; //开始日选好后，重置结束日的最小日期
		 //end.start = datas //将结束日的初始值设定为开始日
	  }
	};
	var timeControl2 = {
	  elem: '#sop_date',
	  format: 'YYYY-MM-DD',
	  //min: laydate.now(), //设定最小日期为当前日期
	  max: '2099-06-16', //最大日期
	  istime: true,
	  istoday: false,
	  choose: function(datas){
		 //end.min = datas; //开始日选好后，重置结束日的最小日期
		 //end.start = datas //将结束日的初始值设定为开始日
	  }
	};
	laydate(timeControl1);
	laydate(timeControl2);
	
	
});

</script>
</html>